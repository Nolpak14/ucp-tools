name: Deploy to Hetzner

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package*.json'
      - 'Dockerfile'
      - 'docker-compose.yml'
  workflow_dispatch:

env:
  SERVER_IP: 188.245.240.175
  SERVER_USER: root
  DEPLOY_PATH: /opt/ucptools

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: Build
        run: npm run build

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Create deployment directory
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "mkdir -p ${{ env.DEPLOY_PATH }}"

      - name: Copy files to server
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'docs-private' \
            --exclude '.env*' \
            ./ ${{ env.SERVER_USER }}@${{ env.SERVER_IP }}:${{ env.DEPLOY_PATH }}/

      - name: Deploy with Docker Compose
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            # Load environment variables
            if [ -f .env.production ]; then
              export $(cat .env.production | xargs)
            fi

            # Build and restart containers
            docker compose build --no-cache
            docker compose up -d

            # Wait for health check
            sleep 10

            # Check if API is healthy
            if curl -f http://localhost:3001/health; then
              echo "Deployment successful!"
            else
              echo "Health check failed, rolling back..."
              docker compose logs ucptools-api
              exit 1
            fi

            # Clean up old images
            docker image prune -f
          EOF

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed! Check the logs above."

  notify-success:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Deployment successful
        run: |
          echo "UCPtools deployed successfully to Hetzner!"
          echo "API available at: https://api.ucptools.dev"
